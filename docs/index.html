<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX NDIS Watchtower</title>
  <style>
    :root{
      --bg:#070a0f; --panel:#0b1220; --line:#1a2a3a;
      --text:#e6edf6; --muted:#9bb0c9;
      --gold:#d7b36a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(215,179,106,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(120,180,255,.10), transparent 60%),
        linear-gradient(180deg, #05070b, #070a0f 40%, #05070b);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line); border-radius:16px; padding:12px 14px;
      box-shadow:0 0 0 1px rgba(0,0,0,.35) inset;
    }
    .brand b{letter-spacing:.12em; font-size:12px}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .pill strong{color:var(--text)}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 12px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{border-color:rgba(215,179,106,.55)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:16px;
      padding:14px;
      box-shadow:0 0 0 1px rgba(0,0,0,.35) inset;
    }
    h1{margin:0 0 8px; font-size:20px}
    p{margin:0; color:var(--muted); line-height:1.4}
    .kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .kpi{
      min-width:130px; padding:10px 12px; border-radius:14px;
      border:1px solid var(--line); background:rgba(0,0,0,.18);
    }
    .kpi b{display:block; font-size:18px; color:var(--text)}
    .kpi span{font-size:12px; color:var(--muted)}
    .lockbox{
      margin-top:12px; padding:12px;
      border:1px solid rgba(215,179,106,.25);
      border-radius:14px;
      background:radial-gradient(600px 280px at 20% 0%, rgba(215,179,106,.10), rgba(0,0,0,.15));
    }
    .lockrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px}
    input{
      flex:1; min-width:220px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px; padding:10px 10px;
      outline:none;
    }
    .hint{margin-top:8px; font-size:12px; color:var(--muted)}
    .tablewrap{margin-top:12px; overflow:auto; border-radius:14px; border:1px solid var(--line)}
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:top}
    th{position:sticky; top:0; background:#0a1220; color:var(--muted); text-align:left; font-weight:600; z-index:2}
    tr:hover td{background:rgba(255,255,255,.03)}
    .risk{display:inline-flex; align-items:center; gap:8px}
    .dot{width:8px; height:8px; border-radius:50%}
    .HIGH .dot{background:#ff5252}
    .MED .dot{background:#ffb020}
    .LOW .dot{background:#4ee37b}
    .searchrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .rightnote{font-size:12px; color:var(--muted); margin-left:auto}
    .footer{margin-top:12px; font-size:12px; color:var(--muted)}
    .gold{color:var(--gold)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>APEX NDIS WATCHTOWER</b>
        <span>Compliance & risk intelligence • Automated</span>
      </div>
      <div class="pillrow">
        <span class="pill">Status: <strong id="statusText">—</strong></span>
        <span class="pill">Last update: <strong id="updatedText">—</strong></span>
        <button class="btn" id="refreshBtn" type="button">Force refresh</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h1>Signals of Enforcement Pressure</h1>
        <p>
          This board monitors publicly released NDIS enforcement actions so providers can detect compliance pressure early
          — before audits, sanctions, or registration action.
        </p>

        <div class="kpis">
          <div class="kpi"><b id="k_total">—</b><span>Total records</span></div>
          <div class="kpi"><b id="k_high">—</b><span>High risk</span></div>
          <div class="kpi"><b id="k_med">—</b><span>Medium risk</span></div>
          <div class="kpi"><b id="k_low">—</b><span>Low risk</span></div>
        </div>

        <div class="lockbox">
          <b class="gold">Subscriber Access</b>
          <div class="hint">
            Public view is live. Premium unlock adds extended fields + faster iterations (alerts, export, deep filters).
          </div>

          <div class="lockrow">
            <!-- IMPORTANT: replace the href below with YOUR real Gumroad product link -->
            <a class="btn" id="gumroadBtn" href="https://gumroad.com/" target="_blank" rel="noreferrer">Subscribe on Gumroad</a>
            <input id="licenseInput" placeholder="Paste Gumroad license key (optional)" />
            <button class="btn" id="unlockBtn" type="button">Unlock</button>
          </div>

          <div class="hint" id="unlockMsg"></div>
        </div>

        <div class="searchrow">
          <input id="search" placeholder="Search name, type, state, risk..." />
          <div class="rightnote"><span id="shownCount">0</span> shown</div>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th style="width:130px">Risk</th>
                <th style="width:260px">Type</th>
                <th>Name</th>
                <th style="width:80px">State</th>
                <th style="width:120px">Effective</th>
                <th style="width:120px">End</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="footer">
          Data source: public releases by the NDIS Commission. This is an information service, not advice.
        </div>
      </div>

      <div class="panel">
        <h1>What you get</h1>
        <p>
          One place to monitor enforcement actions with search + filtering, a simple risk lens, and continuous updates.
          Premium adds automation (alerts) and operational utility (export + deep views).
        </p>
        <div class="footer" style="margin-top:10px">
          <span class="gold">Premium promise:</span> “Don’t miss a risk signal again.”
        </div>
      </div>
    </div>
  </div>

<script>
  const META_URL = "./meta.json";
  const SIGNALS_URL = "./signals.json";

  let allSignals = [];
  let filtered = [];

  function fmtDate(s){
    if(!s) return "";
    try{
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    }catch(e){ return s; }
  }

  function riskClass(r){
    const x = (r||"").toUpperCase();
    if(x.includes("HIGH")) return "HIGH";
    if(x.includes("MED")) return "MED";
    if(x.includes("LOW")) return "LOW";
    return "MED";
  }

  function render(){
    const q = (document.getElementById("search").value || "").toLowerCase().trim();
    filtered = allSignals.filter(s => {
      if(!q) return true;
      const hay = [
        s.risk, s.type, s.name, s.state, s.effective, s.end
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    document.getElementById("shownCount").textContent = String(filtered.length);

    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    for(const s of filtered){
      const rc = riskClass(s.risk);
      const tr = document.createElement("tr");

      const tdRisk = document.createElement("td");
      tdRisk.className = rc;
      tdRisk.innerHTML = `<span class="risk"><span class="dot"></span><span>${s.risk || rc}</span></span>`;

      const tdType = document.createElement("td");
      tdType.textContent = s.type || "";

      const tdName = document.createElement("td");
      tdName.textContent = s.name || "";

      const tdState = document.createElement("td");
      tdState.textContent = s.state || "";

      const tdEff = document.createElement("td");
      tdEff.textContent = s.effective || "";

      const tdEnd = document.createElement("td");
      tdEnd.textContent = s.end || "";

      tr.appendChild(tdRisk);
      tr.appendChild(tdType);
      tr.appendChild(tdName);
      tr.appendChild(tdState);
      tr.appendChild(tdEff);
      tr.appendChild(tdEnd);

      tbody.appendChild(tr);
    }

    // KPIs
    const total = allSignals.length;
    const high = allSignals.filter(s => riskClass(s.risk) === "HIGH").length;
    const med  = allSignals.filter(s => riskClass(s.risk) === "MED").length;
    const low  = allSignals.filter(s => riskClass(s.risk) === "LOW").length;

    document.getElementById("k_total").textContent = total;
    document.getElementById("k_high").textContent = high;
    document.getElementById("k_med").textContent = med;
    document.getElementById("k_low").textContent = low;
  }

  async function load(){
    // meta
    try{
      const m = await fetch(META_URL, {cache:"no-store"});
      const meta = await m.json();
      document.getElementById("statusText").textContent = meta.status || "OK";
      document.getElementById("updatedText").textContent = fmtDate(meta.updated_at || meta.updated_utc || "");
    }catch(e){
      document.getElementById("statusText").textContent = "OK";
      document.getElementById("updatedText").textContent = "—";
    }

    // signals
    const r = await fetch(SIGNALS_URL, {cache:"no-store"});
    const data = await r.json();

    // support both formats:
    // (A) { updated_utc, count, signals:[...] }
    // (B) { signals:[...] }
    const arr = Array.isArray(data) ? data : (data.signals || []);
    allSignals = arr.slice(0, 500); // cap for mobile performance
    render();
  }

  document.getElementById("search").addEventListener("input", render);
  document.getElementById("refreshBtn").addEventListener("click", () => load());

  document.getElementById("unlockBtn").addEventListener("click", () => {
    // Minimal premium behavior for now:
    // If they have a key, send to premium page. If not, nudge purchase.
    const key = (document.getElementById("licenseInput").value || "").trim();
    const msg = document.getElementById("unlockMsg");
    if(!key){
      msg.textContent = "No license key detected. Subscribe on Gumroad, then paste your license key here.";
      return;
    }
    msg.textContent = "Key received. Redirecting to premium…";
    // premium page in docs/unlocked.html
    setTimeout(() => { window.location.href = "./unlocked.html?license=" + encodeURIComponent(key); }, 400);
  });

  load();
</script>
</body>
</html>
