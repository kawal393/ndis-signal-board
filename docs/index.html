<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APEX NDIS Watchtower</title>
  <style>
    :root{
      --bg:#070a0f;
      --panel:#0b1220;
      --panel2:#0a1020;
      --text:#e6edf6;
      --muted:#9bb0c9;
      --line:rgba(255,255,255,.10);
      --gold:#d7b36a;
      --glow:rgba(215,179,106,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(120,160,255,.14), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(215,179,106,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(0,140,255,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 14px;border:1px solid var(--line);
      border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:0 0 0 1px rgba(255,255,255,.03), 0 20px 60px rgba(0,0,0,.35);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{letter-spacing:.10em;font-size:13px}
    .brand span{font-size:12px;color:var(--muted)}
    .pillrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted)
    }
    .pill strong{color:var(--text)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      font-size:12px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);cursor:pointer;text-decoration:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn-gold{
      border-color:rgba(215,179,106,.35);
      background:linear-gradient(180deg, rgba(215,179,106,.18), rgba(215,179,106,.08));
      box-shadow:0 0 0 1px rgba(215,179,106,.12), 0 18px 40px rgba(0,0,0,.25);
    }

    .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      padding:14px;
    }
    h1{margin:0 0 8px;font-size:22px}
    p{margin:0;color:var(--muted);line-height:1.5}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .kpi{
      min-width:130px;padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .kpi b{display:block;font-size:18px}
    .kpi span{font-size:12px;color:var(--muted)}
    .lockbox{
      margin-top:12px;padding:12px;border-radius:18px;border:1px solid rgba(215,179,106,.25);
      background:radial-gradient(600px 200px at 20% 0%, var(--glow), rgba(0,0,0,.25));
    }
    .lockbox h2{margin:0 0 4px;font-size:16px}
    .lockbox .sub{font-size:12px;color:var(--muted);margin-bottom:10px}
    .lockrow{display:flex;gap:8px;flex-wrap:wrap}
    input{
      flex:1;min-width:220px;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--text);outline:none
    }
    .helper{margin-top:8px;font-size:12px;color:var(--muted)}
    .tablewrap{margin-top:12px;overflow:auto;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:top}
    th{color:var(--muted);font-weight:600;text-align:left;background:rgba(255,255,255,.02);position:sticky;top:0}
    tr:hover td{background:rgba(255,255,255,.02)}
    .risk{display:inline-flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%}
    .HIGH .dot{background:#ff5252}
    .MED .dot{background:#ffb020}
    .LOW .dot{background:#4ee37b}
    .small{font-size:12px;color:var(--muted)}
    .searchbar{display:flex;gap:10px;align-items:center;margin-top:12px}
    .countpill{white-space:nowrap}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
    .footer a{color:var(--gold);text-decoration:none}
    .footer a:hover{text-decoration:underline}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>APEX NDIS WATCHTOWER</b>
        <span>Compliance & risk intelligence • Automated</span>
      </div>

      <div class="pillrow">
        <span class="pill">Status: <strong id="status">OK</strong></span>
        <span class="pill">Last update: <strong id="last">—</strong></span>
        <a class="btn" href="#" id="refreshBtn">Force refresh</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h1>Signals of Enforcement Pressure</h1>
        <p>This board ingests publicly released NDIS enforcement data and renders it as a clean, searchable risk feed.</p>

        <div class="kpis">
          <div class="kpi"><b id="k_total">—</b><span>Total records</span></div>
          <div class="kpi"><b id="k_high">—</b><span>High risk</span></div>
          <div class="kpi"><b id="k_med">—</b><span>Medium risk</span></div>
          <div class="kpi"><b id="k_low">—</b><span>Low risk</span></div>
        </div>

        <div class="lockbox">
          <h2>Subscriber Access</h2>
          <div class="sub">Public view is live. Premium unlocks extended fields + premium refresh.</div>

          <div class="lockrow">
            <!-- ✅ Gumroad payment link -->
            <a class="btn btn-gold" target="_blank" rel="noopener"
               href="https://apex888.gumroad.com/l/fouiu">
              Buy Premium on Gumroad
            </a>

            <!-- ✅ Google Form link (NO JS, NO GLITCH) -->
            <a class="btn" target="_blank" rel="noopener"
               href="https://docs.google.com/forms/d/e/1FAIpQLSdhnh-zwjYvPsqLw9cgSKO33_pvhUsB5WrkSkUOhGmNiO_RYQ/viewform">
              Get free weekly signals (email)
            </a>
          </div>

          <div class="helper">
            Optional: if you sell license keys later, you can keep this field. Leaving it does not break anything.
          </div>
          <div class="lockrow" style="margin-top:8px">
            <input id="license" placeholder="Paste Gumroad license key (optional)" />
            <a class="btn" href="#" id="unlockBtn">Unlock</a>
          </div>
          <div class="helper" id="unlockMsg"></div>
        </div>

        <div class="searchbar">
          <input id="q" placeholder="Search name, type, state, risk..." />
          <span class="pill countpill"><strong id="shown">0</strong> shown</span>
        </div>

        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:120px">Risk</th>
                <th style="min-width:220px">Type</th>
                <th style="min-width:280px">Name</th>
                <th style="min-width:80px">State</th>
                <th style="min-width:120px">Effective</th>
                <th style="min-width:120px">End</th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="6" class="small">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="footer">
          Data source: public releases by the NDIS Commission. This is an information service, not advice.
        </div>
      </div>

      <div class="panel">
        <h2 style="margin:0 0 6px;font-size:16px">What you get</h2>
        <p class="small" style="margin:0 0 10px">
          Instant search + filtering, risk visualization, and continuous updates.
        </p>
        <p class="small">
          Premium is for providers, consultants, and compliance roles who want *early warning* and a cleaner workflow than manual browsing.
        </p>
        <div style="height:10px"></div>
        <p class="small">
          If you want a private “Majestic Layer” later, we can route paid users there using a simple password page.
        </p>
      </div>
    </div>
  </div>

<script>
  // ===== Config =====
  const DATA_URLS = [
    "public/signals.json", // bot output
    "docs/signals.json",   // legacy fallback
    "signals.json"         // direct docs root fallback
  ];
  const META_URLS = [
    "public/meta.json",
    "docs/meta.json",
    "meta.json"
  ];

  // ===== Helpers =====
  async function fetchJsonWithFallback(urls){
    let lastErr;
    for (const u of urls){
      try{
        const r = await fetch(u, { cache: "no-store" });
        if(!r.ok) throw new Error(u + " HTTP " + r.status);
        return await r.json();
      } catch(e){ lastErr = e; }
    }
    throw lastErr;
  }

  function safeText(x){ return (x === null || x === undefined) ? "" : String(x); }

  // ===== Render =====
  let ALL = [];

  function renderRows(list){
    const tbody = document.getElementById("rows");
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="6" class="small">No results.</td></tr>`;
      document.getElementById("shown").textContent = "0";
      return;
    }
    const html = list.map(s => {
      const risk = safeText(s.risk || "").toUpperCase() || "MED";
      const cls = (risk === "HIGH" || risk === "MED" || risk === "LOW") ? risk : "MED";
      return `
        <tr class="${cls}">
          <td><span class="risk"><span class="dot"></span><strong>${cls}</strong></span></td>
          <td>${safeText(s.type)}</td>
          <td>${safeText(s.name)}</td>
          <td>${safeText(s.state)}</td>
          <td>${safeText(s.effective)}</td>
          <td>${safeText(s.end)}</td>
        </tr>
      `;
    }).join("");
    tbody.innerHTML = html;
    document.getElementById("shown").textContent = String(list.length);
  }

  function updateKpis(list){
    const total = list.length;
    const high = list.filter(x => (x.risk || "").toUpperCase() === "HIGH").length;
    const med  = list.filter(x => (x.risk || "").toUpperCase() === "MED").length;
    const low  = list.filter(x => (x.risk || "").toUpperCase() === "LOW").length;

    document.getElementById("k_total").textContent = total;
    document.getElementById("k_high").textContent = high;
    document.getElementById("k_med").textContent = med;
    document.getElementById("k_low").textContent = low;
  }

  function applySearch(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    if(!q){
      renderRows(ALL.slice(0, 500));
      return;
    }
    const filtered = ALL.filter(s => {
      const blob = [
        s.risk, s.type, s.name, s.state, s.effective, s.end
      ].map(v => safeText(v).toLowerCase()).join(" | ");
      return blob.includes(q);
    });
    renderRows(filtered.slice(0, 500));
  }

  // ===== Unlock (optional placeholder) =====
  function unlock(){
    const key = document.getElementById("license").value.trim();
    const msg = document.getElementById("unlockMsg");
    if(!key){
      msg.textContent = "No license key entered. Premium access is handled by Gumroad purchase for now.";
      return;
    }
    msg.textContent = "License keys are not enabled yet. (Safe placeholder — does not break site.)";
  }

  // ===== Boot =====
  async function boot(){
    try{
      // meta
      try{
        const meta = await fetchJsonWithFallback(META_URLS);
        if(meta && meta.updated_utc){
          document.getElementById("last").textContent = new Date(meta.updated_utc).toLocaleString();
        }
      }catch(e){
        document.getElementById("last").textContent = "—";
      }

      // signals
      const data = await fetchJsonWithFallback(DATA_URLS);

      // supports BOTH shapes:
      // A) { updated_utc, count, signals:[...] }
      // B) [ ...signals ]
      const signals = Array.isArray(data) ? data : (data.signals || []);
      ALL = signals;

      updateKpis(ALL);
      renderRows(ALL.slice(0, 500));
      document.getElementById("status").textContent = "OK";
    }catch(e){
      document.getElementById("status").textContent = "ERROR";
      document.getElementById("rows").innerHTML =
        `<tr><td colspan="6" class="small">Failed to load data. Check public/signals.json and docs/signals.json.</td></tr>`;
    }
  }

  document.getElementById("q").addEventListener("input", applySearch);
  document.getElementById("unlockBtn").addEventListener("click", (e)=>{ e.preventDefault(); unlock(); });

  document.getElementById("refreshBtn").addEventListener("click", (e)=>{
    e.preventDefault();
    // hard refresh without cache
    location.reload(true);
  });

  boot();
</script>
</body>
</html>
